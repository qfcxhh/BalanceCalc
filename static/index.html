<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>饭卡分账助手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #f8fafc;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --text-color: #374151;
            --border-color: #d1d5db;
        }
        
        body {
            background-color: #f9fafb;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-color);
        }
        
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: none;
        }
        
        .card-header {
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
        }
        
        .form-control {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.95rem;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .btn {
            border-radius: 4px;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .result-card {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            color: white;
        }
        
        .result-number {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .step-item {
            background-color: var(--secondary-color);
            border-left: 3px solid var(--primary-color);
            border-radius: 4px;
            margin-bottom: 8px;
            padding: 12px;
            font-size: 0.9rem;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
            background-color: #ecfdf5;
            color: var(--success-color);
            border: 1px solid #d1fae5;
        }
        
        .history-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .history-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .input-group-text {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 8px;
            }
            
            .result-number {
                font-size: 1.5rem;
            }
            
            .display-6 {
                font-size: 1.8rem !important;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            
            .form-control {
                padding: 0.6rem 0.8rem;
                font-size: 0.95rem;
            }
            
            .input-group-text {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .step-item {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            .history-item {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .col-md-4 {
                margin-bottom: 1rem;
            }
            
            /* Toast提示手机端适配 */
            .toast-container {
                left: 50% !important;
                transform: translateX(-50%);
                right: auto !important;
                width: 90%;
                max-width: 350px;
            }
            
            /* 状态显示手机端优化 */
            .status-badge {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            /* 输入组合手机端优化 */
            .input-group-text {
                min-width: 50px;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .main-container {
                margin: 0.25rem;
                padding: 0.75rem;
            }
            
            .display-6 {
                font-size: 1.5rem !important;
            }
            
            .result-number {
                font-size: 1.3rem;
            }
            
            .btn-lg {
                padding: 0.7rem 1.2rem;
                font-size: 1rem;
            }
            
            /* 超小屏幕快速计算优化 */
            .input-group {
                margin-bottom: 0.75rem;
            }
            
            .history-item .row.small .col-12 {
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }
            
            .card-header h5 {
                font-size: 1rem;
            }
            
            .step-item {
                font-size: 0.8rem;
                padding: 10px;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="main-container fade-in">
                    <!-- 标题和状态 -->
                    <div class="text-center mb-4">
                        <h1 class="display-6 fw-bold mb-2">
                            <i class="fas fa-calculator text-primary"></i> 饭卡分账助手
                        </h1>
                        <p class="text-muted mb-3">计算共享饭卡余额，数据自动保存</p>
                        <div id="statusDisplay" class="d-none">
                            <div class="status-badge">
                                <i class="fas fa-info-circle"></i>
                                <span id="statusText">已有历史数据</span>
                            </div>
                        </div>
                    </div>

                    <!-- 快速操作区 -->
                    <div class="row mb-4" id="quickSection" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-success">
                                        <i class="fas fa-bolt"></i> 快速计算
                                    </h5>
                                    <p class="text-muted small mb-3">基于上次数据快速计算</p>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-4">
                                            <div class="input-group">
                                                <span class="input-group-text">充值</span>
                                                <input type="number" class="form-control" 
                                                       id="quickCharge" placeholder="0" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <div class="input-group">
                                                <span class="input-group-text">剩余</span>
                                                <input type="number" class="form-control" 
                                                       id="quickFinal" placeholder="总余额" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <button class="btn btn-success w-100" onclick="quickCalculate()">
                                                <i class="fas fa-zap"></i> 快速计算
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 完整计算表单 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-edit"></i> 完整计算
                                <button class="btn btn-sm btn-outline-secondary float-end" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#fullCalculation">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </h5>
                        </div>
                        <div class="collapse show" id="fullCalculation">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12 col-md-6 mb-3">
                                        <label class="form-label fw-semibold">饭卡初始总额 (元)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" class="form-control" 
                                                   id="initialTotal" placeholder="14" step="0.01" value="14">
                                        </div>
                                        <small class="form-text text-muted">最开始饭卡有多少钱</small>
                                    </div>
                                    <div class="col-12 col-md-6 mb-3">
                                        <label class="form-label fw-semibold">你的初始金额 (元)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" class="form-control" 
                                                   id="myInitial" placeholder="7" step="0.01" value="7">
                                        </div>
                                        <small class="form-text text-muted">你在饭卡里最开始有多少钱</small>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-12 col-md-6 mb-3">
                                        <label class="form-label fw-semibold">你充值的金额 (元)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" class="form-control" 
                                                   id="myCharge" placeholder="10" step="0.01" value="10">
                                        </div>
                                        <small class="form-text text-muted">往饭卡里充了多少钱</small>
                                    </div>
                                    <div class="col-12 col-md-6 mb-3">
                                        <label class="form-label fw-semibold">打饭后总余额 (元)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" class="form-control" 
                                                   id="finalTotal" placeholder="11.28" step="0.01" value="11.28">
                                        </div>
                                        <small class="form-text text-muted">打完饭后饭卡还剩多少钱</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">备注 (可选)</label>
                                    <input type="text" class="form-control" 
                                           id="note" placeholder="例如：午餐、晚餐等">
                                </div>
                                <div class="text-center">
                                    <button class="btn btn-primary btn-lg" onclick="calculateMoney()">
                                        <i class="fas fa-calculator"></i> 开始计算
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 计算结果 -->
                    <div id="resultSection" style="display: none;">
                        <div class="card result-card mb-4 fade-in">
                            <div class="card-header border-0">
                                <h5 class="text-white mb-0">
                                    <i class="fas fa-chart-pie"></i> 计算结果
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center g-4">
                                    <div class="col-12 col-md-4 mb-3">
                                        <div class="result-number" id="othersMoneyResult">¥0.00</div>
                                        <p class="mb-0 opacity-90">别人的金额</p>
                                    </div>
                                    <div class="col-12 col-md-4 mb-3">
                                        <div class="result-number" id="myRemainingResult">¥0.00</div>
                                        <p class="mb-0 opacity-90">你剩余的金额</p>
                                    </div>
                                    <div class="col-12 col-md-4 mb-3">
                                        <div class="result-number" id="myConsumedResult">¥0.00</div>
                                        <p class="mb-0 opacity-90">你消费的金额</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 计算步骤 -->
                        <div class="card mb-4 fade-in">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-list-ol"></i> 计算步骤
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="calculationSteps"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 历史记录和数据管理 -->
                    <div class="row g-3">
                        <div class="col-12 col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-history"></i> 历史记录
                                    </h5>
                                    <button class="btn btn-warning btn-sm" onclick="loadHistory()">
                                        <i class="fas fa-refresh"></i> 刷新
                                    </button>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="historyList">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-clock fa-2x mb-2"></i>
                                            <p>暂无历史记录</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12 col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-cogs"></i> 数据管理
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-warning" onclick="loadLatestStatus()">
                                            <i class="fas fa-sync-alt"></i> 刷新状态
                                        </button>
                                        <button class="btn btn-danger" onclick="confirmClearData()" 
                                                data-bs-toggle="modal" data-bs-target="#confirmModal">
                                            <i class="fas fa-trash-alt"></i> 清除数据
                                        </button>
                                    </div>
                                    <hr>
                                    <small class="text-muted">
                                        <i class="fas fa-database"></i> 数据自动保存到本地
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认清除数据对话框 -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning"></i> 确认操作
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>确定要清除所有历史数据吗？此操作不可撤销。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="clearAllData()" data-bs-dismiss="modal">
                        <i class="fas fa-trash"></i> 确定清除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <script>
        let currentStatus = null;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadLatestStatus();
            loadHistory();
        });

        // 显示提示信息
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast_' + Date.now();
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-bg-${type}`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                            data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: duration
            });
            
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }

        // 加载最新状态
        async function loadLatestStatus() {
            try {
                const response = await fetch('/api/latest_status/');
                const status = await response.json();
                currentStatus = status;

                if (status.has_data) {
                    document.getElementById('statusDisplay').classList.remove('d-none');
                    document.getElementById('statusText').textContent = 
                        `别人: ¥${status.others_money.toFixed(2)}, 你剩余: ¥${status.my_remaining.toFixed(2)}`;
                    
                    document.getElementById('quickSection').style.display = 'block';
                } else {
                    document.getElementById('statusDisplay').classList.add('d-none');
                    document.getElementById('quickSection').style.display = 'none';
                }
            } catch (error) {
                console.log('首次使用，无历史数据');
            }
        }

        // 快速计算
        async function quickCalculate() {
            const chargeAmount = parseFloat(document.getElementById('quickCharge').value) || 0;
            const finalTotal = parseFloat(document.getElementById('quickFinal').value);

            if (isNaN(finalTotal)) {
                showToast('请输入打饭后的总余额', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/quick_calculate/?charge_amount=${chargeAmount}&final_total=${finalTotal}&note=快速计算`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResult(result);
                    showToast('快速计算完成', 'success');
                    loadLatestStatus();
                    loadHistory();
                } else {
                    const error = await response.json();
                    showToast(error.detail || '快速计算失败', 'danger');
                }
            } catch (error) {
                showToast('网络错误，请重试', 'danger');
            }
        }

        // 完整计算
        async function calculateMoney() {
            const initialTotal = parseFloat(document.getElementById('initialTotal').value);
            const myInitial = parseFloat(document.getElementById('myInitial').value);
            const myCharge = parseFloat(document.getElementById('myCharge').value);
            const finalTotal = parseFloat(document.getElementById('finalTotal').value);
            const note = document.getElementById('note').value.trim();

            // 验证输入
            if (isNaN(initialTotal) || isNaN(myInitial) || isNaN(myCharge) || isNaN(finalTotal)) {
                showToast('请填写所有数字字段', 'warning');
                return;
            }

            if (initialTotal < 0 || myInitial < 0 || myCharge < 0 || finalTotal < 0) {
                showToast('所有金额都必须大于等于0', 'warning');
                return;
            }

            if (myInitial > initialTotal) {
                showToast('你的初始金额不能超过饭卡总额', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/calculate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initial_total: initialTotal,
                        my_initial: myInitial,
                        my_charge: myCharge,
                        final_total: finalTotal,
                        note: note
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResult(result);
                    showToast('计算完成并已保存', 'success');
                    loadLatestStatus();
                    loadHistory();
                } else {
                    const error = await response.json();
                    showToast(error.detail || '计算失败', 'danger');
                }
            } catch (error) {
                showToast('网络错误，请重试', 'danger');
            }
        }

        // 显示计算结果
        function displayResult(result) {
            document.getElementById('resultSection').style.display = 'block';
            
            document.getElementById('othersMoneyResult').textContent = `¥${result.others_money.toFixed(2)}`;
            document.getElementById('myRemainingResult').textContent = `¥${result.my_remaining.toFixed(2)}`;
            document.getElementById('myConsumedResult').textContent = `¥${result.my_consumed.toFixed(2)}`;
            
            const stepsContainer = document.getElementById('calculationSteps');
            stepsContainer.innerHTML = result.calculation_steps.map((step, index) => `
                <div class="step-item fade-in" style="animation-delay: ${index * 0.1}s">
                    <strong>步骤 ${index + 1}:</strong> ${step}
                </div>
            `).join('');
            
            document.getElementById('resultSection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // 加载历史记录
        async function loadHistory() {
            try {
                const response = await fetch('/api/history/');
                const history = await response.json();
                
                const historyContainer = document.getElementById('historyList');
                
                if (history.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>暂无历史记录</p>
                        </div>
                    `;
                } else {
                    historyContainer.innerHTML = history.map(record => `
                        <div class="history-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="row small g-2">
                                        <div class="col-12 col-sm-4">
                                            <strong>余额:</strong> ¥${record.my_remaining.toFixed(2)}
                                        </div>
                                        <div class="col-12 col-sm-4">
                                            <strong>消费:</strong> ¥${record.my_consumed.toFixed(2)}
                                        </div>
                                        <div class="col-12 col-sm-4">
                                            <strong>充值:</strong> ¥${record.my_charge.toFixed(2)}
                                        </div>
                                    </div>
                                    ${record.note ? `<div class="text-muted small mt-1">${record.note}</div>` : ''}
                                    <div class="text-muted small mt-1">${new Date(record.created_at).toLocaleString('zh-CN')}</div>
                                </div>
                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="deleteHistory(${record.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                showToast('加载历史记录失败', 'danger');
            }
        }

        // 删除历史记录
        async function deleteHistory(recordId) {
            try {
                const response = await fetch(`/api/history/${recordId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('记录已删除', 'success');
                    loadHistory();
                    loadLatestStatus();
                } else {
                    showToast('删除失败', 'danger');
                }
            } catch (error) {
                showToast('网络错误', 'danger');
            }
        }

        // 清除所有数据
        async function clearAllData() {
            try {
                const response = await fetch('/api/history/', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('所有数据已清除', 'success');
                    loadHistory();
                    loadLatestStatus();
                    document.getElementById('resultSection').style.display = 'none';
                } else {
                    showToast('清除失败', 'danger');
                }
            } catch (error) {
                showToast('网络错误', 'danger');
            }
        }

        // 回车键提交
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (document.activeElement.closest('#quickSection')) {
                    quickCalculate();
                } else {
                    calculateMoney();
                }
            }
        });

        // 清除输入框（双击）
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('dblclick', function() {
                this.value = '';
                this.focus();
            });
        });
    </script>
</body>
</html>